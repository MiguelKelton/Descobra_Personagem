<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Buscador de Personagem - Black Clover</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; padding: 20px; }
        input { font-size: 16px; padding: 5px; }
        button { font-size: 16px; padding: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
        .card { 
            background: #333; 
            border: 1px solid #555; 
            border-radius: 8px; 
            padding: 15px; 
            max-width: 400px;
        }
        .card img { max-width: 100%; border-radius: 4px; }
        .info-item { margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;}
        .info-item strong { color: #8fbc8f; /* verde claro */ }
    </style>
</head>
<body>

    <h1>Buscador de Personagens (Black Clover Wiki)</h1>
    
    <input type="text" id="charNameInput" placeholder="Digite o nome do personagem (ex: Asta)">
    <button id="searchButton">Buscar</button>
    <div id="loading" style="display: none; margin-top: 10px;">Buscando...</div>
    
    <div id="results"></div>

<script>
        // --- ELEMENTOS DO HTML ---
        const input = document.getElementById('charNameInput');
        const button = document.getElementById('searchButton');
        const loading = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');

        // --- ENDPOINTS DA API ---
        const SEARCH_API_ENDPOINT = 'https://blackclover.fandom.com/pt-br/api.php';
        const PROXY_URL = 'https://api.allorigins.win/raw?url=';
        const PAGE_API_URL = 'https://blackclover.fandom.com/pt-br/api/rest_v1/page/mobile-html/';

        // --- ADICIONA O "ESCUTADOR" NO BOTÃO ---
        button.addEventListener('click', handleSearch);
        input.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        /**
         * Pega o valor do input e inicia o processo
         */
        async function handleSearch() {
            const charName = input.value;
            if (!charName) {
                alert('Por favor, digite um nome.');
                return;
            }
            
            resultsDiv.innerHTML = '';
            loading.style.display = 'block';

            try {
                // ETAPA 1: Encontrar o nome exato da página
                const exactPageTitle = await findExactPageTitle(charName);
                
                // ETAPA 2: Fazer o scraping da página com o nome exato
                const infoPersonagem = await getPersonagemInfo(exactPageTitle);
                
                // ETAPA 3: Mostrar os resultados
                displayResults(infoPersonagem);

            } catch (error) {
                console.error('Erro no processo:', error);
                resultsDiv.innerHTML = `<p style="color: red;">${error.message}</p>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        /**
         * ETAPA 1: Usa a API de busca (MediaWiki) para encontrar o nome correto.
         * @param {string} termoDeBusca - O nome que o usuário digitou.
         */
        async function findExactPageTitle(termoDeBusca) {
            console.log(`Etapa 1: Buscando o título exato para "${termoDeBusca}"...`);
            
            const params = new URLSearchParams({
                action: 'query',
                list: 'search',
                srsearch: termoDeBusca,
                format: 'json',
                origin: '*' // Permite CORS para esta API
            });

            const url = `${SEARCH_API_ENDPOINT}?${params.toString()}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Falha ao conectar na API de busca do Fandom.');
            }
            
            const data = await response.json();
            const resultados = data.query.search;

            if (resultados.length === 0) {
                throw new Error(`Nenhum personagem encontrado para "${termoDeBusca}".`);
            }

            // Pega o título do primeiro resultado (o mais relevante)
            const tituloExato = resultados[0].title;
            console.log(`Etapa 1: Título encontrado: "${tituloExato}"`);
            
            // Formata para o padrão da API de scraping (ex: "Zora Ideale" -> "Zora_Ideale")
            return tituloExato.replace(/ /g, '_');
        }

        /**
         * ETAPA 2: Faz o scraping do HTML usando o proxy e o nome exato da página.
         * @param {string} nomePagina - O nome formatado (ex: "Zora_Ideale")
         */
        async function getPersonagemInfo(nomePagina) {
            console.log(`Etapa 2: Fazendo scraping da página "${nomePagina}"...`);
            
            const urlOriginal = PAGE_API_URL + nomePagina;
            const finalUrl = PROXY_URL + encodeURIComponent(urlOriginal);

            const response = await fetch(finalUrl);

            if (!response.ok) {
                throw new Error(`Erro de rede ao buscar dados do personagem (Status: ${response.status})`);
            }
            
            const htmlString = await response.text();

            // DEBUG: Loga o HTML para vermos o que veio
            // console.log("--- HTML Recebido ---", htmlString); // Descomente se der erro de novo

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');

            const infobox = doc.querySelector('.portable-infobox');
            if (!infobox) {
                // Se falhar aqui, o proxy pode estar sendo bloqueado ou a página não tem infobox
                throw new Error('Não foi possível encontrar a Infobox. A estrutura da página pode ter mudado ou o proxy foi bloqueado.');
            }

            const getInfo = (dataSource) => {
                const element = infobox.querySelector(`[data-source="${dataSource}"] .pi-data-value`);
                return element ? element.textContent.trim() : 'Não encontrado';
            };

            const imagemElement = infobox.querySelector('.pi-image-thumbnail');
            const imagemUrl = imagemElement ? imagemElement.src : '';

            const infoPersonagem = {
                nome: infobox.querySelector('.pi-title')?.textContent.trim() || nomePagina.replace(/_/g, ' '),
                imagem: imagemUrl,
                esquadrao: getInfo('esquadrao'),
                magia: getInfo('magia'),
                especie: getInfo('especie'),
                grimorio: getInfo('grimorio'),
                idade: getInfo('idade')
            };
            
            console.log("Etapa 2: Dados extraídos com sucesso!");
            return infoPersonagem;
        }

        /**
         * ETAPA 3: Mostra os dados na tela (sem mudanças aqui)
         */
        function displayResults(info) {
            resultsDiv.innerHTML = '';
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h2>${info.nome}</h2>
                ${info.imagem ? `<img src="${info.imagem}" alt="Imagem de ${info.nome}">` : ''}
                <div class="info-item"><strong>Personagem:</strong> ${info.nome}</div>
                <div class="info-item"><strong>Esquadrão:</strong> ${info.esquadrao}</div>
                <div class="info-item"><strong>Tipo de Magia:</strong> ${info.magia}</div>
                <div class="info-item"><strong>Espécie:</strong> ${info.especie}</div>
                <div class="info-item"><strong>Grimório:</strong> ${info.grimorio}</div>
                <div class="info-item"><strong>Idade:</strong> ${info.idade}</div>
            `;
            resultsDiv.appendChild(card);
        }
    </script>
    </body>
</html>